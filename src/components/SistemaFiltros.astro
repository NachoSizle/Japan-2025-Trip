---
// Componente completo de sistema de filtros para itinerario
import DayCard from './DayCard.astro';

// Definir interfaces para mejorar el tipado
interface Actividad {
  hora: string;
  actividad: string;
  ubicacion: string;
  tipo: string;
  notas?: string;
  gluten_free?: boolean;
  destacado?: boolean;
  maps_url?: string;
  direccion?: string;
}

interface Dia {
  dia: number;
  fecha: string;
  titulo: string;
  ciudad: string;
  actividades: Actividad[];
}

interface ActividadConFiltros extends Actividad {
  isGlutenFree: boolean;
  isDestacado: boolean;
  isTurismo: boolean;
}

interface DiaConFiltros extends Dia {
  actividadesConFiltros: ActividadConFiltros[];
  hasGlutenFree: boolean;
  hasDestacado: boolean;
  hasTurismo: boolean;
}

// Extraer todas las ciudades únicas para filtros adicionales
const { dias } = Astro.props;
const ciudades = [...new Set(dias.map((dia: Dia) => dia.ciudad))];

// Función para obtener el icono según el tipo de actividad
const getActivityIcon = (tipo: string): string => {
  switch (tipo) {
    case 'turismo':
      return '🗼';
    case 'comida':
      return '🍱';
    case 'transporte':
      return '🚄';
    case 'alojamiento':
      return '🏨';
    case 'compras':
      return '🛍️';
    default:
      return '📍';
  }
};

// Preparar datos para la plantilla - cada día con sus propiedades adicionales
const diasConFiltros: DiaConFiltros[] = dias.map((dia: Dia) => {
  return {
    ...dia,
    actividadesConFiltros: dia.actividades.map((act: Actividad) => ({
      ...act,
      isGlutenFree: act.gluten_free === true,
      isDestacado: act.destacado === true,
      isTurismo: act.tipo === 'turismo'
    })),
    hasGlutenFree: dia.actividades.some((act: Actividad) => act.gluten_free === true),
    hasDestacado: dia.actividades.some((act: Actividad) => act.destacado === true),
    hasTurismo: dia.actividades.some((act: Actividad) => act.tipo === 'turismo')
  };
});
---

<div x-data="{ activeFilter: 'todos', activeCiudad: 'todas', filtersOpen: false }">
  <!-- Panel de control de filtros colapsable -->
  <div class="mb-8">
    <button 
      @click="filtersOpen = !filtersOpen" 
      class="filter-toggle-button mx-auto flex items-center justify-center gap-2 px-4 py-3 rounded-lg shadow-md transition-all duration-300 hover:shadow-lg">
      <span>Filtrar itinerario</span>
      <span x-text="filtersOpen ? '▲' : '▼'" class="text-xs transition-transform duration-300" :class="filtersOpen ? 'transform rotate-180' : ''"></span>
    </button>
    
    <div 
      x-show="filtersOpen" 
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 transform -translate-y-4"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100 transform translate-y-0"
      x-transition:leave-end="opacity-0 transform -translate-y-4"
      class="filter-panel mt-4 p-5 rounded-xl backdrop-blur-sm">
      
      <h3 class="text-lg font-bold mb-4 text-center">Tipos de actividades</h3>
      <!-- Botones de filtros rápidos -->
      <div class="flex flex-wrap justify-center gap-1 sm:gap-2 md:gap-4 mb-6 px-2">
        <button 
          @click="activeFilter = 'todos'; activeCiudad = 'todas'" 
          :class="activeFilter === 'todos' && activeCiudad === 'todas' ? 'filter-active-primary' : 'filter-inactive-primary'"
          class="px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 border-2 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
          Todos los días
        </button>
        <button 
          @click="activeFilter = 'gluten-free'" 
          :class="activeFilter === 'gluten-free' ? 'filter-active-gluten' : 'filter-inactive-gluten'"
          class="px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 border-2 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
          🌾🚫 Sin Gluten
        </button>
        <button 
          @click="activeFilter = 'destacados'" 
          :class="activeFilter === 'destacados' ? 'filter-active-featured' : 'filter-inactive-featured'"
          class="px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 border-2 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
          ⭐ Destacados
        </button>
        <button 
          @click="activeFilter = 'turismo'" 
          :class="activeFilter === 'turismo' ? 'filter-active-tourism' : 'filter-inactive-tourism'"
          class="px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 border-2 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
          🗼 Turismo
        </button>
      </div>
  
      <h3 class="text-lg font-bold mb-4 text-center">Ciudades</h3>
      <!-- Filtros por ciudad -->
      <div class="flex flex-wrap justify-center gap-1 sm:gap-2 md:gap-4 mb-6 px-2">
        <button 
          @click="activeCiudad = 'todas'" 
          :class="activeCiudad === 'todas' ? 'filter-active-city' : 'filter-inactive-city'"
          class="px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 border-2 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
          Todas
        </button>
        {ciudades.map((ciudad) => (
          <button 
            @click={`activeCiudad = '${ciudad}'`} 
            :class={`activeCiudad === '${ciudad}' ? 'filter-active-city' : 'filter-inactive-city'`}
            class="px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 border-2 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
            {ciudad}
          </button>
        ))}
      </div>
    </div>
  </div>
  
  <!-- Contador de días filtrados -->
  <div class="text-center mb-8">
    <p x-data="{ 
      get filteredCount() {
        return document.querySelectorAll('.daycard-container:not([style*=\'display: none\'])').length;
      } 
    }" class="filter-counter" x-text="`Mostrando ${filteredCount} de ${diasConFiltros.length} días`"></p>
  </div>

  <!-- Lista de días filtrada -->
  <div class="space-y-6 sm:space-y-8 md:space-y-12">
    {diasConFiltros.map((dia: DiaConFiltros) => (
      <div 
        class="relative max-w-2xl mx-auto daycard-container"
        x-show={`
          (activeFilter === 'todos' || 
          (activeFilter === 'gluten-free' && ${dia.hasGlutenFree}) ||
          (activeFilter === 'destacados' && ${dia.hasDestacado}) ||
          (activeFilter === 'turismo' && ${dia.hasTurismo})) &&
          (activeCiudad === 'todas' || activeCiudad === '${dia.ciudad}')
        `}
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-95">
        
        <!-- Cabecera del día -->
          <!-- Cabecera del día -->
          <div class="daycard-header p-4 sm:p-5 md:p-6 rounded-t-xl backdrop-blur-sm">
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center gap-2">
                <h3 class="text-lg sm:text-xl md:text-2xl font-bold" style="color: #FF1493; text-shadow: 0 0 10px rgba(255, 20, 147, 0.5);">Día {dia.dia}</h3>
                <span class="font-mono text-sm" style="color: rgba(255, 255, 255, 0.7);">{dia.fecha}</span>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-medium bg-opacity-20 backdrop-blur-sm" 
                    style="background-color: rgba(255, 20, 147, 0.3); color: white; border: 1px solid #FF1493;">
                {dia.ciudad}
              </span>
            </div>
            <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-2" 
                style="background: linear-gradient(135deg, #FF1493, #FF6B6B); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
              {dia.titulo}
            </h2>
          </div>
          
          <!-- Lista de actividades filtradas -->        <!-- Lista de actividades filtradas -->
        <div class="daycard-body p-4 sm:p-5 md:p-6 rounded-b-xl backdrop-blur-sm">
          {dia.actividadesConFiltros.map((act: ActividadConFiltros, index: number) => (
            <div 
              id={`activity-${dia.dia}-${index}`}
              class={`activity-item mb-2 py-2 px-3 rounded-lg activity-${act.tipo} ${act.isGlutenFree ? 'gluten-free-activity' : ''} ${act.isDestacado ? 'featured-activity' : ''}`}
              style="background: rgba(25, 25, 25, 0.7); box-shadow: 0 4px 12px rgba(255, 20, 147, 0.4);"
              x-show={`
                activeFilter === 'todos' || 
                (activeFilter === 'gluten-free' && ${act.isGlutenFree}) ||
                (activeFilter === 'destacados' && ${act.isDestacado}) || 
                (activeFilter === 'turismo' && ${act.isTurismo})
              `}
            >
              <div class="flex items-start gap-1">
                <div class="activity-icon-container flex-shrink-0 bg-white rounded-full w-7 h-7 flex items-center justify-center">
                  <span class="activity-icon text-white">{getActivityIcon(act.tipo)}</span>
                </div>
                <div class="activity-content flex-1 ml-1">
                  <div class="flex flex-wrap items-center gap-1">
                    <h4 class="font-bold text-base activity-title leading-tight mt-0 mb-0">{act.actividad}</h4>
                    {act.isGlutenFree && (
                      <span class="activity-tag-gf text-xs">
                        🌾🚫
                      </span>
                    )}
                    {act.isDestacado && (
                      <span class="activity-tag-featured text-xs">
                        ⭐
                      </span>
                    )}
                  </div>
                  <div class="flex items-center text-xs">
                    <span class="activity-time font-mono">{act.hora}</span>
                    <span class="mx-1">•</span>
                    {act.tipo === 'alojamiento' && act.maps_url ? (
                      <a href={act.maps_url} target="_blank" rel="noopener noreferrer" class="activity-details map-link">
                        <span class="map-link-inner">📍 Ver en mapa</span>
                      </a>
                    ) : (
                      <span class="activity-details">{act.ubicacion}</span>
                    )}
                  </div>
                  {act.notas && <p class="text-xs activity-notes italic text-opacity-80">{act.notas}</p>}
                </div>
              </div>
            </div>
          ))}
          
          <!-- Enlace a la página completa del día -->
          <div class="mt-3 text-center">
            <a href={`${import.meta.env.BASE_URL}itinerario/${dia.dia}`} class="view-full-day-link px-4 py-1.5 rounded-full text-sm font-medium inline-block transition-all duration-300">
              Ver día completo →
            </a>
          </div>
        </div>
      </div>
    ))}
  </div>
</div>

<style>
  /* Estilos para el contenedor de día */
  .daycard-container {
    background: rgba(255, 20, 147, 0.08);
    border: 1px solid rgba(255, 20, 147, 0.3);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease-in-out;
    margin-bottom: 2rem;
    border-radius: 0.75rem;
    overflow: hidden;
  }
  
  .daycard-container:hover {
    border-color: rgba(255, 20, 147, 0.5);
    box-shadow: 0 8px 32px rgba(255, 20, 147, 0.2);
    transform: translateY(-5px);
  }
  
  :global([data-theme="light"]) .daycard-container {
    background: rgba(255, 245, 245, 0.9);
    border: 2px solid rgba(255, 107, 107, 0.3);
  }
  
  :global([data-theme="light"]) .daycard-container:hover {
    border-color: rgba(220, 20, 60, 0.5);
    box-shadow: 0 8px 32px rgba(220, 20, 60, 0.2);
  }
  
  .daycard-header {
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid rgba(255, 20, 147, 0.3);
  }
  
  :global([data-theme="light"]) .daycard-header {
    background: rgba(255, 20, 147, 0.1);
    border-bottom: 1px solid rgba(255, 20, 147, 0.2);
  }
  
  .daycard-body {
    background: rgba(0, 0, 0, 0.1);
  }
  
  :global([data-theme="light"]) .daycard-body {
    background: rgba(255, 255, 255, 0.5);
  }
  
  /* Estilos para los botones de filtro */
  .filter-active-primary {
    background: #FF1493 !important;
    color: white !important;
    border-color: #FF1493 !important;
    box-shadow: 0 0 20px rgba(255, 20, 147, 0.6);
  }
  .filter-inactive-primary {
    background: transparent !important;
    color: #FF1493 !important;
    border-color: #FF1493 !important;
  }
  .filter-inactive-primary:hover {
    box-shadow: 0 0 20px rgba(255, 20, 147, 0.4);
  }
  .filter-active-gluten {
    background: #FF6B6B !important;
    color: white !important;
    border-color: #FF6B6B !important;
    box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
  }
  .filter-inactive-gluten {
    background: transparent !important;
    color: #FF6B6B !important;
    border-color: #FF6B6B !important;
  }
  .filter-inactive-gluten:hover {
    box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
  }
  .filter-active-featured {
    background: #FF0040 !important;
    color: white !important;
    border-color: #FF0040 !important;
    box-shadow: 0 0 20px rgba(255, 0, 64, 0.6);
  }
  .filter-inactive-featured {
    background: transparent !important;
    color: #FF0040 !important;
    border-color: #FF0040 !important;
  }
  .filter-inactive-featured:hover {
    box-shadow: 0 0 20px rgba(255, 0, 64, 0.4);
  }
  .filter-active-tourism {
    background: #FF8A80 !important;
    color: #1a1a1a !important;
    border-color: #FF8A80 !important;
    box-shadow: 0 0 20px rgba(255, 138, 128, 0.6);
  }
  .filter-inactive-tourism {
    background: transparent !important;
    color: #FF8A80 !important;
    border-color: #FF8A80 !important;
  }
  .filter-inactive-tourism:hover {
    box-shadow: 0 0 20px rgba(255, 138, 128, 0.4);
  }
  
  /* Estilos para filtros de ciudad */
  .filter-active-city {
    background: #D81159 !important;
    color: white !important;
    border-color: #D81159 !important;
    box-shadow: 0 0 20px rgba(216, 17, 89, 0.6);
  }
  .filter-inactive-city {
    background: transparent !important;
    color: #D81159 !important;
    border-color: #D81159 !important;
  }
  .filter-inactive-city:hover {
    box-shadow: 0 0 20px rgba(216, 17, 89, 0.4);
  }
  
  .filter-counter {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  :global([data-theme="light"]) .filter-counter {
    color: #4b5563 !important;
  }
  
  .clickable-hint {
    color: rgba(255, 255, 255, 0.5);
  }
  :global([data-theme="light"]) .clickable-hint {
    color: #4b5563 !important;
    font-weight: 500;
  }
  
  /* Estilos para las actividades */
  .activity-item {
    background: rgba(0, 0, 0, 0.3);
    border-left: 4px solid;
    margin-bottom: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  
  .activity-item:hover {
    transform: translateX(3px);
    box-shadow: 0 4px 12px rgba(255, 20, 147, 0.3);
  }
  
  .activity-item::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 5px;
    background: linear-gradient(to bottom, rgba(255, 20, 147, 0.5), rgba(255, 107, 107, 0.5));
  }
  
  :global([data-theme="light"]) .activity-item {
    background: rgba(255, 240, 240, 0.8);
  }
  
  /* Colores por tipo de actividad */
  .activity-transporte { border-left-color: #FF6B6B !important; }
  .activity-alojamiento { border-left-color: #FF8A80 !important; }
  .activity-comida { border-left-color: #FF0040 !important; }
  .activity-turismo { border-left-color: #FF1493 !important; }
  .activity-cultura { border-left-color: #FF8A80 !important; }
  .activity-naturaleza { border-left-color: #FFB3BA !important; }
  
  .gluten-free-activity {
    border-left-color: #FF6B6B !important;
  }
  
  .featured-activity {
    border-left-color: #FF0040 !important;
  }

  .activity-icon {
    color: white;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  
  :global([data-theme="light"]) .activity-icon {
    color: white;
  }
  
  .activity-title {
    color: white;
    font-weight: 700;
    background: linear-gradient(135deg, #FF1493, #FF6B6B);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  :global([data-theme="light"]) .activity-title {
    background: linear-gradient(135deg, #D81159, #8A1253);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .activity-time {
    color: rgba(255, 255, 255, 0.7);
    font-family: monospace;
  }
  
  :global([data-theme="light"]) .activity-time {
    color: #4b5563;
    font-weight: 600;
  }
  
  .activity-details {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
  }
  
  :global([data-theme="light"]) .activity-details {
    color: #4b5563;
    font-weight: 500;
  }
  
  /* Estilo para enlace a mapa */
  .map-link {
    text-decoration: none;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
  }
  
  .map-link-inner {
    background: rgba(255, 20, 147, 0.2);
    border-radius: 4px;
    padding: 2px 6px;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
    font-size: 0.75rem;
    transition: all 0.2s ease;
    border: 1px solid rgba(255, 20, 147, 0.3);
  }
  
  .map-link:hover .map-link-inner {
    background: rgba(255, 20, 147, 0.4);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(255, 20, 147, 0.3);
  }
  
  :global([data-theme="light"]) .map-link-inner {
    background: rgba(255, 20, 147, 0.15);
    color: #D81159;
    border: 1px solid rgba(255, 20, 147, 0.2);
  }
  
  :global([data-theme="light"]) .map-link:hover .map-link-inner {
    background: rgba(255, 20, 147, 0.25);
    color: #FF1493;
  }
  
  .activity-notes {
    font-style: italic;
    color: rgba(255, 255, 255, 0.6);
  }
  
  :global([data-theme="light"]) .activity-notes {
    color: #4b5563;
    font-weight: 500;
  }
  
  /* Etiquetas */
  .activity-tag-gf {
    background: linear-gradient(135deg, #FF8A80, #FF6B6B);
    color: white;
    font-size: 0.65rem;
    padding: 0.1rem 0.3rem;
    border-radius: 9999px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(255, 138, 128, 0.4);
  }
  
  .activity-tag-featured {
    background: linear-gradient(135deg, #FF1493, #FF0040);
    color: white;
    font-size: 0.65rem;
    padding: 0.1rem 0.3rem;
    border-radius: 9999px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(255, 20, 147, 0.4);
  }
  
  .view-full-day-link {
    background: linear-gradient(135deg, #FF1493 0%, #FF6B6B 100%);
    color: white;
    font-weight: 600;
    border-radius: 9999px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(255, 20, 147, 0.3);
    border: none;
    text-decoration: none !important;
  }
  
  .view-full-day-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(255, 20, 147, 0.4);
    background: linear-gradient(135deg, #FF6B6B 0%, #FF1493 100%);
  }
  
  /* Estilos para el panel de filtros colapsable */
  .filter-toggle-button {
    background: linear-gradient(135deg, #D81159 0%, #FF1493 100%);
    color: white;
    font-weight: 600;
    width: auto;
    min-width: 200px;
    letter-spacing: 0.5px;
    border: none;
  }
  
  .filter-toggle-button:hover {
    background: linear-gradient(135deg, #FF1493 0%, #D81159 100%);
    transform: translateY(-1px);
  }
  
  .filter-panel {
    background-color: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }
  
  :global([data-theme="light"]) .filter-panel {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  :global([data-theme="light"]) .filter-toggle-button {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  
  :global([data-theme="light"]) .activity-item {
    background-color: rgba(0, 0, 0, 0.05);
    border-left-color: rgba(0, 0, 0, 0.1);
  }
  
  :global([data-theme="light"]) .activity-item:hover {
    background-color: rgba(0, 0, 0, 0.08);
  }
  
  :global([data-theme="light"]) .activity-time {
    color: #4b5563;
  }
  
  :global([data-theme="light"]) .view-full-day-link {
    background: linear-gradient(135deg, #FF1493 0%, #FF6B6B 100%);
    color: white;
    box-shadow: 0 4px 10px rgba(255, 20, 147, 0.2);
  }
  
  :global([data-theme="light"]) .view-full-day-link:hover {
    background: linear-gradient(135deg, #FF6B6B 0%, #FF1493 100%);
    box-shadow: 0 6px 15px rgba(255, 20, 147, 0.3);
  }
</style>
